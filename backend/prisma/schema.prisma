generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String         @id @default(dbgenerated("gen_random_uuid()"))
  email                   String         @unique
  username                String         @unique
  passwordHash            String?
  authProvider            AuthProvider   @default(email)
  emailVerified           Boolean        @default(false)
  role                    UserRole       @default(user)
  avatarUrl               String?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  resetToken              String?
  resetTokenExpiry        DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  deletedAt               DateTime?
  notifications           Notification[]
  reminderLogs            ReminderLog[]
  seasonConfigChanges     SeasonConfig[] @relation("SeasonConfigChangedBy")
  teams                   Team[]

  @@index([email])
  @@index([username])
}

model Team {
  id              String        @id @default(dbgenerated("gen_random_uuid()"))
  userId          String
  name            String
  seasonYear      Int
  paymentStatus   PaymentStatus @default(draft)
  stripePaymentId String?       @unique
  entryStatus     EntryStatus   @default(draft)
  totalHrs2024    Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lockedAt        DateTime?
  deletedAt       DateTime?
  leaderboards    Leaderboard[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamPlayers     TeamPlayer[]

  @@index([userId])
  @@index([entryStatus])
  @@index([seasonYear])
  @@index([paymentStatus])
}

model Player {
  id                String              @id @default(dbgenerated("gen_random_uuid()"))
  mlbId             String              @unique
  name              String
  teamAbbr          String
  photoUrl          String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  PlayerSeasonStats PlayerSeasonStats[]
  playerStats       PlayerStats[]
  teamPlayers       TeamPlayer[]
}

model TeamPlayer {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  teamId    String
  playerId  String
  position  Int
  createdAt DateTime @default(now())
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@index([playerId])
}

model PlayerStats {
  id               String   @id @default(dbgenerated("gen_random_uuid()"))
  playerId         String
  seasonYear       Int
  date             DateTime @db.Date
  hrsTotal         Int      @default(0)
  hrsRegularSeason Int      @default(0)
  hrsPostseason    Int      @default(0)
  lastUpdated      DateTime @updatedAt
  player           Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, seasonYear, date])
  @@index([playerId])
  @@index([seasonYear])
  @@index([date])
}

model Leaderboard {
  id              String          @id @default(dbgenerated("gen_random_uuid()"))
  teamId          String
  leaderboardType LeaderboardType
  month           Int?
  rank            Int
  totalHrs        Int
  calculatedAt    DateTime        @default(now())
  team            Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, leaderboardType, month])
  @@index([leaderboardType])
  @@index([rank])
  @@index([month])
}

model Notification {
  id      String           @id @default(dbgenerated("gen_random_uuid()"))
  userId  String?
  type    NotificationType
  subject String
  body    String
  sentAt  DateTime         @default(now())
  readAt  DateTime?
  user    User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sentAt])
}

model ReminderLog {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  reminderType   ReminderType
  sentAt         DateTime     @default(now())
  sentById       String
  recipientCount Int
  metadata       Json?
  sentBy         User         @relation(fields: [sentById], references: [id], onDelete: Cascade)

  @@index([reminderType])
  @@index([sentAt])
}

model PlayerSeasonStats {
  id         String    @id @default(dbgenerated("gen_random_uuid()"))
  playerId   String
  seasonYear Int
  hrsTotal   Int       @default(0)
  teamAbbr   String?   @db.VarChar(10)
  createdAt  DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @db.Timestamptz(6)
  Player     Player    @relation(fields: [playerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([playerId, seasonYear])
  @@index([hrsTotal], map: "idx_player_season_stats_hrs")
  @@index([playerId], map: "idx_player_season_stats_player")
  @@index([seasonYear], map: "idx_player_season_stats_season")
}

enum AuthProvider {
  email
  google
}

enum UserRole {
  user
  admin
}

enum PaymentStatus {
  draft
  pending
  paid
  rejected
  refunded
}

enum EntryStatus {
  draft
  entered
  locked
}

enum LeaderboardType {
  overall
  monthly
  allstar
}

enum NotificationType {
  email
  in_app
}

enum ReminderType {
  payment
  lock_deadline
}

enum SeasonPhase {
  off_season
  registration
  active
  completed
}

model SeasonConfig {
  id                    String       @id @default(dbgenerated("gen_random_uuid()"))
  seasonYear            Int          @unique
  phase                 SeasonPhase  @default(off_season)
  registrationOpenDate  DateTime?    @db.Date
  registrationCloseDate DateTime?    @db.Date
  seasonStartDate       DateTime?    @db.Date
  seasonEndDate         DateTime?    @db.Date
  isCurrentSeason       Boolean      @default(false)
  lastPhaseChange       DateTime     @default(now())
  changedBy             String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  changedByUser         User?        @relation("SeasonConfigChangedBy", fields: [changedBy], references: [id])

  @@index([seasonYear])
}
