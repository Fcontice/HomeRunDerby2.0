generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String         @id @default(dbgenerated("gen_random_uuid()"))
  email                   String         @unique
  username                String         @unique
  passwordHash            String?
  authProvider            AuthProvider   @default(email)
  emailVerified           Boolean        @default(false)
  role                    UserRole       @default(user)
  avatarUrl               String?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  resetToken              String?
  resetTokenExpiry        DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  deletedAt               DateTime?
  phoneNumber             String?        @db.VarChar(20)
  profileCompleted        Boolean        @default(true)
  notifications           Notification[]
  reminderLogs            ReminderLog[]
  seasonConfigChanges     SeasonConfig[] @relation("SeasonConfigChangedBy")
  teams                   Team[]

  @@index([email])
  @@index([username])
}

model Team {
  id            String        @id @default(dbgenerated("gen_random_uuid()"))
  userId        String
  name          String
  seasonYear    Int
  paymentStatus PaymentStatus @default(draft)
  entryStatus   EntryStatus   @default(draft)
  totalHrs2024  Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lockedAt      DateTime?
  deletedAt     DateTime?
  paymentNotes  String?
  leaderboards  Leaderboard[]
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamPlayers   TeamPlayer[]

  @@index([userId])
  @@index([entryStatus])
  @@index([seasonYear])
  @@index([paymentStatus])
}

model Player {
  id                String              @id @default(dbgenerated("gen_random_uuid()"))
  mlbId             String              @unique
  name              String
  teamAbbr          String
  photoUrl          String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  PlayerSeasonStats PlayerSeasonStats[]
  playerStats       PlayerStats[]
  teamPlayers       TeamPlayer[]
}

model TeamPlayer {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  teamId    String
  playerId  String
  position  Int
  createdAt DateTime @default(now())
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@index([playerId])
  @@index([teamId], map: "idx_team_player_team_id")
}

model PlayerStats {
  id               String   @id @default(dbgenerated("gen_random_uuid()"))
  playerId         String
  seasonYear       Int
  date             DateTime @db.Date
  hrsTotal         Int      @default(0)
  hrsRegularSeason Int      @default(0)
  hrsPostseason    Int      @default(0)
  lastUpdated      DateTime @updatedAt
  hrsDaily         Int      @default(0)
  player           Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, seasonYear, date])
  @@index([playerId])
  @@index([seasonYear])
  @@index([date])
  @@index([playerId, seasonYear, date(sort: Desc)], map: "idx_player_stats_player_season_date")
  @@index([seasonYear, date, hrsDaily, playerId], map: "idx_player_stats_monthly_sum")
}

model Leaderboard {
  id              String          @id @default(dbgenerated("gen_random_uuid()"))
  teamId          String
  leaderboardType LeaderboardType
  month           Int?
  rank            Int
  totalHrs        Int
  calculatedAt    DateTime        @default(now())
  seasonYear      Int             @default(2025)
  team            Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, leaderboardType, month])
  @@index([leaderboardType])
  @@index([rank])
  @@index([month])
  @@index([seasonYear])
  @@index([leaderboardType, seasonYear], map: "Leaderboard_type_season_idx")
  @@index([leaderboardType, seasonYear, rank], map: "idx_leaderboard_type_season_rank")
}

model Notification {
  id      String           @id @default(dbgenerated("gen_random_uuid()"))
  userId  String?
  type    NotificationType
  subject String
  body    String
  sentAt  DateTime         @default(now())
  readAt  DateTime?
  user    User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sentAt])
}

model ReminderLog {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  reminderType   ReminderType
  sentAt         DateTime     @default(now())
  sentById       String
  recipientCount Int
  metadata       Json?
  sentBy         User         @relation(fields: [sentById], references: [id], onDelete: Cascade)

  @@index([reminderType])
  @@index([sentAt])
}

model JobExecutionLog {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobName       String
  status        String
  startTime     DateTime  @db.Timestamptz(6)
  endTime       DateTime? @db.Timestamptz(6)
  durationMs    Int?
  errorMessage  String?
  errorStack    String?
  context       Json?
  adminNotified Boolean?  @default(false)
  notifiedAt    DateTime? @db.Timestamptz(6)
  createdAt     DateTime? @default(now()) @db.Timestamptz(6)

  @@index([jobName], map: "idx_job_execution_log_job_name")
  @@index([jobName, status], map: "idx_job_execution_log_job_name_status")
  @@index([startTime(sort: Desc)], map: "idx_job_execution_log_start_time")
  @@index([status], map: "idx_job_execution_log_status")
}

model PlayerSeasonStats {
  id         String    @id @default(dbgenerated("gen_random_uuid()"))
  playerId   String
  seasonYear Int
  hrsTotal   Int       @default(0)
  teamAbbr   String?   @db.VarChar(10)
  createdAt  DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @db.Timestamptz(6)
  Player     Player    @relation(fields: [playerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([playerId, seasonYear])
  @@index([hrsTotal], map: "idx_player_season_stats_hrs")
  @@index([playerId], map: "idx_player_season_stats_player")
  @@index([seasonYear], map: "idx_player_season_stats_season")
}

model SeasonConfig {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  seasonYear            Int       @unique
  phase                 String    @default("off_season")
  registrationOpenDate  DateTime? @db.Date
  registrationCloseDate DateTime? @db.Date
  seasonStartDate       DateTime? @db.Date
  seasonEndDate         DateTime? @db.Date
  isCurrentSeason       Boolean?  @default(false)
  lastPhaseChange       DateTime? @default(now()) @db.Timestamp(6)
  changedBy             String?
  createdAt             DateTime? @default(now()) @db.Timestamp(6)
  updatedAt             DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  changedByUser         User?     @relation("SeasonConfigChangedBy", fields: [changedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([seasonYear])
}

enum AuthProvider {
  email
  google
}

enum UserRole {
  user
  admin
}

enum PaymentStatus {
  draft
  paid
  refunded
}

enum EntryStatus {
  draft
  entered
  locked
}

enum LeaderboardType {
  overall
  monthly
  allstar
}

enum NotificationType {
  email
  in_app
}

enum ReminderType {
  payment
  lock_deadline
}
